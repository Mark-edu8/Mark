// Function to sanitize strings by replacing curly quotes and unwanted characters
function sanitizeString(input) {
  if (input && typeof input === 'string') {
    return input.replace(/[‘’“”—–]/g, function (match) {
      // Replace curly quotes with straight quotes and other special characters
      switch (match) {
        case '\u2018': return "'";
        case '\u2019': return "'";
        case '\u201C': return '"';
        case '\u201D': return '"';
        case '\u2014': return '--';
        case '\u2013': return '-';
        default: return match;
      }
    }).replace(/[\u200B\uFEFF]/g, ''); // Remove Zero-width space characters
  }
  return input;
}

function createGitHubPost() {
  var folderInfo = getDriveFolder(); // Get the current folder where images are uploaded
  if (folderInfo.error) {
    throw new Error(folderInfo.error);
  }

  var folder = DriveApp.getFolderById(folderInfo.folderId);
  var files = folder.getFilesByType(MimeType.GOOGLE_SHEETS);
  var contentInputFile = null;

  while (files.hasNext()) {
    var file = files.next();
    if (file.getName().includes("content-input")) {
      contentInputFile = file;
      break;
    }
  }

  if (!contentInputFile) {
    throw new Error("content-input Google Sheets file not found in the folder.");
  }

  var sheet = SpreadsheetApp.open(contentInputFile).getSheetByName("commentary");
  if (!sheet) {
    throw new Error("Sheet 'commentary' not found in content-input file.");
  }

  var lang = sheet.getRange("B7").getValue(); 
  var category = sheet.getRange("B1").getValue();
  var title = sheet.getRange("B8").getValue();
  var date = sheet.getRange("A1").getValue();

  if (!title || !date || !lang || !category) {
    throw new Error("Title, date, language, or category is missing in the spreadsheet.");
  }

  var formattedDate = Utilities.formatDate(new Date(date), Session.getScriptTimeZone(), "yyyy-MM-dd");

  // Apply sanitizeString to title
  var sanitizedTitle = sanitizeString(title);

  var frontMatter = `---\nlang: ${lang}\ncategory: ${category}\ntitle: "${sanitizedTitle}"\ndate: ${formattedDate}\n---\n\n`;

  var content = "";
  for (var i = 2; i <= 6; i++) {
    var titleContent = sheet.getRange("A" + i).getValue();
    var bodyContent = sheet.getRange("B" + i).getValue();
    var imageLink = sheet.getRange("C" + i).getValue();

    // Apply sanitizeString to content and image link
    if (titleContent || bodyContent) {
      content += "### " + sanitizeString(titleContent) + "\n\n" + sanitizeString(bodyContent) + "\n\n";
      if (imageLink) {
        content += `![Image](${sanitizeString(imageLink)})\n\n`;
      }
    }
  }

  var owner = "MarkLeighEdu";
  var repo = "markleighedu.github.io";
  var token = PropertiesService.getScriptProperties().getProperty("GITHUB_TOKEN");
  if (!token) {
    throw new Error("GitHub token is missing in Script Properties.");
  }

  var fileName = `${formattedDate}-${sanitizedTitle.replace(/\s+/g, "-").toLowerCase()}.md`;
  var apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/_posts/${fileName}`;

  // Check if file exists and delete it
  var sha = null;
  try {
    var getFileResponse = UrlFetchApp.fetch(apiUrl, {
      "method": "get",
      "headers": {
        "Authorization": "token " + token,
        "Content-Type": "application/json"
      }
    });

    var fileData = JSON.parse(getFileResponse.getContentText());
    sha = fileData.sha; // Extract SHA of the existing file

    // Delete the file if it exists
    var deleteUrl = apiUrl;
    var deleteOptions = {
      "method": "delete",
      "headers": {
        "Authorization": "token " + token,
        "Content-Type": "application/json"
      },
      "payload": JSON.stringify({
        "message": `Delete old post: ${fileName}`,
        "sha": sha,
        "branch": "main"
      })
    };

    UrlFetchApp.fetch(deleteUrl, deleteOptions);
    Utilities.sleep(2000); // Wait for GitHub to process the deletion before uploading new file

  } catch (e) {
    if (e.toString().indexOf("404") === -1) {
      throw new Error("Error checking/deleting file: " + e.toString());
    }
    // 404 means file doesn't exist, continue
  }

  // Upload new file
  var payload = {
    "message": `Add new post: ${fileName}`,
    "content": Utilities.base64Encode(frontMatter + content),
    "branch": "main"
  };

  var options = {
    "method": "put",
    "headers": {
      "Authorization": "token " + token,
      "Content-Type": "application/json"
    },
    "payload": JSON.stringify(payload)
  };

  var response = UrlFetchApp.fetch(apiUrl, options);
  return "GitHub Post Created Successfully: " + fileName;
}
